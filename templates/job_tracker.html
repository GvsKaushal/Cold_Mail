{% include 'header.html' %}
{% include 'navbar.html' %}

<div class="container my-5">
    <h1 class="text-center text-primary">{{ title }}</h1>
    <hr class="mb-4">

    {% if message %}
    <div class="alert alert-info text-center" role="alert">
        {{ message }}
    </div>
    {% else %}
    <div class="row">
        {% for job in jobs %}
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-primary"><strong>Role:</strong> {{ job.role }}</h5>
                    <p class="card-text"><strong>Status:</strong> <span
                            class="badge bg-secondary">{{ job.status }}</span></p>
                    <p><strong>Email Draft:</strong></p>
                    <button class="btn btn-secondary text-decoration-none" type="button" data-bs-toggle="collapse"
                            data-bs-target="#email-{{ job._id }}" aria-expanded="false"
                            aria-controls="email-{{ job._id }}">
                        Show/Hide Email
                    </button>
                    <div class="collapse my-3" id="email-{{ job._id }}">
                        <pre class="bg-light p-3 rounded">{{ job.email }}</pre>
                    </div>

                    <!-- Dropdown to update job status -->
                    <div class="mt-3">
                        <div class="input-group">
                            <select name="status" id="status-{{ job._id }}" class="form-select">
                                {% for status in ["Draft", "Applied", "Interview", "Offered", "Rejected", "Accepted"] %}
                                <option value="{{ status }}" {% if status== job.status %}selected{% endif %}>
                                    {{ status }}
                                </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-primary" type="button" onclick="updateStatus('{{ job._id }}')">
                                Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    async function updateStatus(jobId) {
        const status = document.getElementById(`status-${jobId}`).value;

        try {
            const response = await fetch(`/update-status/${jobId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({ status: status }),
            });

            if (response.ok) {
                location.reload();
            } else {
                const errorData = await response.json();
                alert(`Error: ${errorData.detail || 'Could not update status'}`);
            }
        } catch (error) {
            console.error('Error updating status:', error);
            alert('An error occurred while updating the status.');
        }
    }
</script>

{% include 'footer.html' %}
